name: protect-main

on:
  # Only run for direct pushes to main
  push:
    branches:
    - main
jobs:
  # Check if Docker files were modified
  docker-check:
    uses: ./.github/workflows/docker-check.yml

  # Then run the protection logic
  protect-main:
    needs: docker-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Enforce PR requirement
      run: |
        # Check if this is a merge commit (more than one parent)
        MERGE_COMMIT=$(if [[ "$(git log -1 --pretty=%P | wc -w)" -gt 1 ]]; then echo "true"; else echo "false"; fi)

        # Block if Docker files changed and it's not a merge commit
        if [[ "${{ needs.docker-check.outputs.docker_changed }}" == "true" && "$MERGE_COMMIT" == "false" ]]; then
          echo "‚ùå ERROR: Direct modifications to Docker files are NOT allowed on main."
          echo "üîí Please create a pull request instead."
          exit 1
        else
          echo "‚úÖ Main branch protection check passed."
        fi
