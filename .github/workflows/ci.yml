name: Pipeline

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:

  # Test against key4hep releases
  test_key4hep:
    env:
      KEY4HEP_IMAGE: ghcr.io/key4hep/key4hep-images/alma9
      KEY4HEP_BASE: /cvmfs/sw.hsf.org/key4hep
      LWTNN_ROOT: /cvmfs/sft.cern.ch/lcg/views/LCG_106/x86_64-el9-gcc13-opt
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        releases: [2024-11-28]

    steps:
      - uses: actions/checkout@v4
      - uses: cvmfs-contrib/github-action-cvmfs@v4
      - name: Build and test
        run: |
          docker run --rm \
            --device /dev/fuse \
            --cap-add SYS_ADMIN \
            --volume /cvmfs:/cvmfs:shared \
            --volume ${{ github.workspace }}:/workspace \
            --workdir /workspace \
            ${{ env.KEY4HEP_IMAGE }} bash -c "
              echo '::group::Set-up key4hep environment'


              echo -e '#!/bin/bash
              source ${{ env.KEY4HEP_BASE }}/setup.sh -r ${{ matrix.releases }}

              # Create the local bin directory if it does not exist
              mkdir -p ~/.local/bin
              export PATH=~/.local/bin:${PATH}

              # Download cvmfs-venv script
              curl -sL https://raw.githubusercontent.com/jbeirer/cvmfs-venv/main/cvmfs-venv.sh -o ~/.local/bin/cvmfs-venv
              chmod +x ~/.local/bin/cvmfs-venv

              # Set up and activate the virtual environment
              cvmfs-venv fcs-venv && . fcs-venv/bin/activate

              # Install pipreqs and generate requirements
              pip install --user pipreqs
              pipreqs test/python --mode no-pin

              # Install the required packages
              pip install --user -r test/python/requirements.txt
              ' > setup.sh

              chmod +x setup.sh
              source setup.sh

              echo '::group::Configure'
              cmake --preset=ci-linux-lcg -Dlwtnn_ROOT=${LWTNN_ROOT}

              echo '::group::Build'
              cmake --build build --config Release -j 4

              echo '::group::Install'
              cmake --install build --config Release --prefix prefix

              echo '::group::Test'
              ctest --test-dir build --output-on-failure --no-tests=error -C Release -j 4
            "
